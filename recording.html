<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recording Submission - Web Usability Project</title>
    <link rel="stylesheet" href="format.css">
</head>
<body>
    <div class="text text-recording">
        <button class="back-button" onclick="goBack()">← Back</button>
        <h1>Recording Submission</h1>
        
        <div id="promptSection">
            <p id="promptLabel">Your Prompt:</p>
            <p id="promptText">Loading prompt...</p>
            <button id="generatePromptBtn" onclick="loadPrompt()">Generate New Prompt</button>
        </div>

        <div id="instructions">
            <h4>Instructions</h4>
            <ul>
                <li>Allow camera access when prompted</li>
                <li>Record yourself responding to the prompt above</li>
                <li>Keep your recording to approximately 1 minute</li>
                <li>Click "Stop" when finished, then "Submit"</li>
            </ul>
        </div>

        <div id="statusMessage"></div>

        <div id="videoContainer">
            <video id="videoPreview" playsinline autoplay muted></video>
            <div id="timerDisplay">00:00</div>
            <div id="recordingIndicator">
                <span id="recordingDot"></span>
                RECORDING
            </div>
            <div id="audioVisualizerContainer">
                <div id="audioVisualizer"></div>
            </div>
        </div>

        <div id="controlsSection">
            <button id="startBtn" onclick="startRecording()">Start Recording</button>
            <button id="stopBtn" onclick="stopRecording()" disabled>Stop Recording</button>
            <button id="resetBtn" onclick="resetRecording()">Reset</button>
            <button id="submitBtn" onclick="submitRecording()" disabled>Submit</button>
        </div>

        <div id="submittedScreen">
            <h2>Recording Submitted!</h2>
            <p class="success-message">✓ Your recording has been successfully submitted.</p>
            <p class="success-subtext">Preparing to show your feedback...</p>
            <button id="nextBtn" onclick="goToFeedback()">Next</button>
        </div>
    </div>

    <script>
        let mediaStream;
        let mediaRecorder;
        let recordedChunks = [];
        let recordingStartTime;
        let timerInterval;
        const maxRecordingTime = 60000; // 1 minute in milliseconds

        // Sample prompts - in production, this would come from the server
        const prompts = [
            "Describe your favorite way to spend a weekend.",
            "Tell us about a challenge you overcame recently.",
            "What's your ideal way to learn something new?",
            "Share a memorable experience from your life.",
            "What does creativity mean to you?"
        ];

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initializeStyles();
            loadPrompt();
        });

        function goBack() {
            window.location.href = "input.html";
        }

        function initializeStyles() {
            // All styles are now defined in format.css
            // This function is kept for backward compatibility
        }

        let audioContext;
        let analyser;
        let animationId;

        function setupAudioVisualizer() {
            if (!audioContext && mediaStream) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                // Create visualizer bars
                const visualizer = document.getElementById('audioVisualizer');
                visualizer.innerHTML = '';
                const barCount = 30;
                for (let i = 0; i < barCount; i++) {
                    const bar = document.createElement('div');
                    bar.classList.add('audio-bar');
                    visualizer.appendChild(bar);
                }

                updateAudioBars();
            }
        }

        function updateAudioBars() {
            if (!analyser) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const visualizer = document.getElementById('audioVisualizer');
            const bars = visualizer.querySelectorAll('div');
            const barCount = bars.length;

            for (let i = 0; i < barCount; i++) {
                const index = Math.floor((i / barCount) * dataArray.length);
                const value = dataArray[index];
                const height = Math.max(2, (value / 255) * 30);
                bars[i].style.height = height + 'px';
            }

            animationId = requestAnimationFrame(updateAudioBars);
        }

        function stopAudioVisualizer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function loadPrompt() {
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('promptText').textContent = randomPrompt;
        }

        async function initializeCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: true
                });
                document.getElementById('videoPreview').srcObject = mediaStream;
                showStatus('Camera ready. Click "Start Recording" to begin.', 'info');
                
                // Now that camera is ready, actually start recording
                startRecording();
            } catch (error) {
                showStatus('Error accessing camera: ' + error.message, 'error');
                document.getElementById('startBtn').disabled = false;
            }
        }

        function startRecording() {
            // Initialize camera only when starting to record
            if (!mediaStream) {
                initializeCamera();
                return; // Will call startRecording again after camera is ready
            }

            const videoContainer = document.getElementById('videoContainer');
            videoContainer.style.display = 'block'; // Show video container

            recordedChunks = [];
            recordingStartTime = Date.now();

            // Create media recorder
            mediaRecorder = new MediaRecorder(mediaStream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 2500000
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstart = () => {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').style.display = 'flex';
                document.getElementById('audioVisualizerContainer').style.display = 'flex';
                setupAudioVisualizer();
                startTimer();
                showStatus('Recording in progress...', 'info');
            };

            mediaRecorder.onstop = () => {
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('recordingIndicator').style.display = 'none';
                document.getElementById('audioVisualizerContainer').style.display = 'none';
                stopAudioVisualizer();
                stopTimer();
                showStatus('Recording stopped. Review and submit or reset to try again.', 'success');
            };

            mediaRecorder.start();

            // Auto-stop after 1 minute
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                    showStatus('Maximum recording time reached. Click "Submit" to submit your recording.', 'info');
                }
            }, maxRecordingTime);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function resetRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            recordedChunks = [];
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('recordingIndicator').style.display = 'none';
            document.getElementById('audioVisualizerContainer').style.display = 'none';
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('videoContainer').style.display = 'none'; // Hide video container
            stopTimer();
            stopAudioVisualizer();
            
            // Stop camera stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            showStatus('', '');
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - recordingStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const displaySeconds = seconds % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')}`;
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function submitRecording() {
            if (recordedChunks.length === 0) {
                showStatus('No recording found. Please record before submitting.', 'error');
                return;
            }

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            
            // Create FormData to send the recording
            const formData = new FormData();
            formData.append('recording', blob, 'recording.webm');
            formData.append('prompt', document.getElementById('promptText').textContent);

            // In production, send to server
            console.log('Submitting recording...');
            console.log('Recording size:', blob.size, 'bytes');
            
            // Stop camera stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Stop audio visualizer
            stopAudioVisualizer();
            
            // Hide recording interface
            document.getElementById('promptSection').style.display = 'none';
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('controlsSection').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
            
            // Show submitted screen
            document.getElementById('submittedScreen').style.display = 'block';
            
            document.getElementById('submitBtn').disabled = true;
        }

        function goToFeedback() {
            // In production: window.location.href = 'feedback.html';
            console.log('Redirecting to feedback.html');
            // For demo, just show that it's navigating
            document.getElementById('submittedScreen').innerHTML = '<p>Redirecting to feedback page...</p>';
            setTimeout(function() {
                window.location.href = 'feedback.html';
            }, 1500);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.className = '';
            statusDiv.style.display = 'none';
            
            if (message) {
                statusDiv.style.display = 'block';
                statusDiv.classList.add(type);
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>