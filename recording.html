<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recording Submission - Web Usability Project</title>
    <link rel="stylesheet" href="format.css">
</head>
<body>
    <div class="text">
        <button class="back-button" onclick="goBack()">← Back</button>
        <h1>Recording Submission</h1>
        
        <div id="promptSection">
            <p id="promptLabel">Your Prompt:</p>
            <p id="promptText">Loading prompt...</p>
            <button id="generatePromptBtn" onclick="loadPrompt()">Generate New Prompt</button>
        </div>

        <div id="instructions">
            <h4>Instructions</h4>
            <ul>
                <li>Allow camera access when prompted</li>
                <li>Record yourself responding to the prompt above</li>
                <li>Keep your recording to approximately 1 minute</li>
                <li>Click "Stop" when finished, then "Submit"</li>
            </ul>
        </div>

        <div id="statusMessage"></div>

        <div id="videoContainer">
            <video id="videoPreview" playsinline autoplay muted></video>
            <div id="timerDisplay">00:00</div>
            <div id="recordingIndicator">
                <span id="recordingDot"></span>
                RECORDING
            </div>
            <div id="audioVisualizerContainer">
                <div id="audioVisualizer"></div>
            </div>
        </div>

        <div id="controlsSection">
            <button id="startBtn" onclick="startRecording()">Start Recording</button>
            <button id="stopBtn" onclick="stopRecording()" disabled>Stop Recording</button>
            <button id="resetBtn" onclick="resetRecording()">Reset</button>
            <button id="submitBtn" onclick="submitRecording()" disabled>Submit</button>
        </div>

        <div id="submittedScreen">
            <h2>Recording Submitted!</h2>
            <p class="success-message">✓ Your recording has been successfully submitted.</p>
            <p class="success-subtext">Preparing to show your feedback...</p>
            <button id="nextBtn" onclick="goToFeedback()">Next</button>
        </div>
    </div>

    <script>
        let mediaStream;
        let mediaRecorder;
        let recordedChunks = [];
        let recordingStartTime;
        let timerInterval;
        const maxRecordingTime = 60000; // 1 minute in milliseconds

        // Sample prompts - in production, this would come from the server
        const prompts = [
            "Describe your favorite way to spend a weekend.",
            "Tell us about a challenge you overcame recently.",
            "What's your ideal way to learn something new?",
            "Share a memorable experience from your life.",
            "What does creativity mean to you?"
        ];

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            initializeStyles();
            loadPrompt();
        });

        function goBack() {
            window.location.href = "input.html";
        }

        function initializeStyles() {
            // Video container styling
            const videoContainer = document.getElementById('videoContainer');
            videoContainer.style.position = 'relative';
            videoContainer.style.width = '100%';
            videoContainer.style.backgroundColor = '#000';
            videoContainer.style.borderRadius = '8px';
            videoContainer.style.overflow = 'hidden';
            videoContainer.style.marginBottom = '20px';
            videoContainer.style.aspectRatio = '4/3';
            videoContainer.style.display = 'none'; // Hide until recording starts

            // Text container styling for spacing
            const textContainer = document.querySelector('.text');
            textContainer.style.marginTop = '40px';
            textContainer.style.marginBottom = '40px';
            textContainer.style.overflowY = 'auto';
            textContainer.style.maxHeight = '90vh';
            textContainer.style.paddingTop = '20px';
            textContainer.style.paddingBottom = '20px';
            textContainer.style.backgroundColor = '#fdc482';
            textContainer.style.borderRadius = '20px';
            textContainer.style.minWidth = '400px';
            textContainer.style.maxWidth = '900px';
            textContainer.style.width = '90%';

            // Video styling
            const video = document.getElementById('videoPreview');
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.display = 'block';
            video.style.objectFit = 'cover';
            video.style.transform = 'scaleX(-1)'; // Mirror effect
            video.style.backgroundColor = '#000';

            // Timer display styling
            const timerDisplay = document.getElementById('timerDisplay');
            timerDisplay.style.position = 'absolute';
            timerDisplay.style.top = '15px';
            timerDisplay.style.right = '15px';
            timerDisplay.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            timerDisplay.style.color = '#fff';
            timerDisplay.style.padding = '8px 12px';
            timerDisplay.style.borderRadius = '4px';
            timerDisplay.style.fontFamily = 'monospace';
            timerDisplay.style.fontSize = '16px';
            timerDisplay.style.fontWeight = 'bold';

            // Recording indicator styling
            const recordingIndicator = document.getElementById('recordingIndicator');
            recordingIndicator.style.position = 'absolute';
            recordingIndicator.style.top = '15px';
            recordingIndicator.style.left = '15px';
            recordingIndicator.style.display = 'none';
            recordingIndicator.style.alignItems = 'center';
            recordingIndicator.style.gap = '8px';
            recordingIndicator.style.backgroundColor = 'rgba(255, 0, 0, 0.9)';
            recordingIndicator.style.color = 'white';
            recordingIndicator.style.padding = '8px 12px';
            recordingIndicator.style.borderRadius = '4px';
            recordingIndicator.style.fontWeight = 'bold';

            // Recording dot styling
            const recordingDot = document.getElementById('recordingDot');
            recordingDot.style.width = '10px';
            recordingDot.style.height = '10px';
            recordingDot.style.backgroundColor = '#fff';
            recordingDot.style.borderRadius = '50%';
            recordingDot.style.animation = 'blink 1s infinite';

            // Add blink animation
            const style = document.createElement('style');
            style.innerHTML = '@keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.3; } }';
            document.head.appendChild(style);

            // Controls section styling
            const controlsSection = document.getElementById('controlsSection');
            controlsSection.style.display = 'flex';
            controlsSection.style.gap = '15px';
            controlsSection.style.marginBottom = '20px';
            controlsSection.style.flexWrap = 'wrap';

            // Status message styling
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.style.padding = '12px';
            statusMessage.style.borderRadius = '4px';
            statusMessage.style.marginBottom = '20px';
            statusMessage.style.textAlign = 'center';
            statusMessage.style.fontWeight = 'bold';
            statusMessage.style.display = 'none';

            // Instructions styling
            const instructions = document.getElementById('instructions');
            instructions.style.backgroundColor = '#fff3cd';
            instructions.style.border = '1px solid #ffeaa7';
            instructions.style.padding = '15px';
            instructions.style.borderRadius = '4px';
            instructions.style.marginBottom = '20px';
            instructions.style.color = '#856404';

            // Prompt section styling
            const promptSection = document.getElementById('promptSection');
            promptSection.style.backgroundColor = '#e8f4f8';
            promptSection.style.padding = '20px';
            promptSection.style.borderLeft = '4px solid #2196F3';
            promptSection.style.marginBottom = '30px';
            promptSection.style.borderRadius = '4px';

            // Prompt text styling
            const promptText = document.getElementById('promptText');
            promptText.style.fontSize = '18px';
            promptText.style.color = '#2196F3';
            promptText.style.fontStyle = 'italic';

            // Audio visualizer styling
            const audioVisualizerContainer = document.getElementById('audioVisualizerContainer');
            audioVisualizerContainer.style.position = 'absolute';
            audioVisualizerContainer.style.bottom = '0';
            audioVisualizerContainer.style.left = '0';
            audioVisualizerContainer.style.width = '100%';
            audioVisualizerContainer.style.height = '40px';
            audioVisualizerContainer.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            audioVisualizerContainer.style.display = 'flex';
            audioVisualizerContainer.style.alignItems = 'center';
            audioVisualizerContainer.style.justifyContent = 'center';
            audioVisualizerContainer.style.gap = '2px';
            audioVisualizerContainer.style.display = 'none';

            const audioVisualizer = document.getElementById('audioVisualizer');
            audioVisualizer.style.display = 'flex';
            audioVisualizer.style.gap = '2px';
            audioVisualizer.style.height = '100%';
            audioVisualizer.style.alignItems = 'center';
            audioVisualizer.style.width = '100%';
            audioVisualizer.style.justifyContent = 'center';

            // Generate prompt button styling
            const generatePromptBtn = document.getElementById('generatePromptBtn');
            if (generatePromptBtn) {
                generatePromptBtn.style.backgroundColor = '#6a72a3';
                generatePromptBtn.style.color = '#003a79';
                generatePromptBtn.style.padding = '8px 16px';
                generatePromptBtn.style.borderRadius = '8px';
                generatePromptBtn.style.border = 'none';
                generatePromptBtn.style.cursor = 'pointer';
                generatePromptBtn.style.fontSize = '14px';
                generatePromptBtn.style.fontFamily = 'Georgia, Times New Roman, Times, serif';
                generatePromptBtn.addEventListener('mouseover', () => {
                    generatePromptBtn.style.backgroundColor = '#ad9a91';
                });
                generatePromptBtn.addEventListener('mouseout', () => {
                    generatePromptBtn.style.backgroundColor = '#6a72a3';
                });
            }

            // Submitted screen styling
            const submittedScreen = document.getElementById('submittedScreen');
            submittedScreen.style.padding = '40px 20px';
            submittedScreen.style.minHeight = '300px';
            submittedScreen.style.display = 'none';

            // Next button styling
            const nextBtn = document.getElementById('nextBtn');
            if (nextBtn) {
                nextBtn.style.backgroundColor = '#6a72a3';
                nextBtn.style.color = '#003a79';
                nextBtn.style.padding = '12px 30px';
                nextBtn.style.fontSize = '16px';
                nextBtn.style.border = '#003a79 2px';
                nextBtn.style.borderRadius = '8px';
                nextBtn.style.cursor = 'pointer';
                nextBtn.style.fontFamily = 'Georgia, Times New Roman, Times, serif';
                nextBtn.style.fontWeight = 'bold';
                nextBtn.addEventListener('mouseover', () => {
                    nextBtn.style.backgroundColor = '#ad9a91';
                });
                nextBtn.addEventListener('mouseout', () => {
                    nextBtn.style.backgroundColor = '#6a72a3';
                });
            }
        }

        let audioContext;
        let analyser;
        let animationId;

        function setupAudioVisualizer() {
            if (!audioContext && mediaStream) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(mediaStream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                source.connect(analyser);

                // Create visualizer bars
                const visualizer = document.getElementById('audioVisualizer');
                visualizer.innerHTML = '';
                const barCount = 30;
                for (let i = 0; i < barCount; i++) {
                    const bar = document.createElement('div');
                    bar.style.width = '3px';
                    bar.style.minHeight = '2px';
                    bar.style.backgroundColor = '#4CAF50';
                    bar.style.borderRadius = '2px';
                    bar.style.flex = '1';
                    visualizer.appendChild(bar);
                }

                updateAudioBars();
            }
        }

        function updateAudioBars() {
            if (!analyser) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            const visualizer = document.getElementById('audioVisualizer');
            const bars = visualizer.querySelectorAll('div');
            const barCount = bars.length;

            for (let i = 0; i < barCount; i++) {
                const index = Math.floor((i / barCount) * dataArray.length);
                const value = dataArray[index];
                const height = Math.max(2, (value / 255) * 30);
                bars[i].style.height = height + 'px';
            }

            animationId = requestAnimationFrame(updateAudioBars);
        }

        function stopAudioVisualizer() {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }

        function loadPrompt() {
            const randomPrompt = prompts[Math.floor(Math.random() * prompts.length)];
            document.getElementById('promptText').textContent = randomPrompt;
        }

        async function initializeCamera() {
            try {
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: true
                });
                document.getElementById('videoPreview').srcObject = mediaStream;
                showStatus('Camera ready. Click "Start Recording" to begin.', 'info');
                
                // Now that camera is ready, actually start recording
                startRecording();
            } catch (error) {
                showStatus('Error accessing camera: ' + error.message, 'error');
                document.getElementById('startBtn').disabled = false;
            }
        }

        function startRecording() {
            // Initialize camera only when starting to record
            if (!mediaStream) {
                initializeCamera();
                return; // Will call startRecording again after camera is ready
            }

            const videoContainer = document.getElementById('videoContainer');
            videoContainer.style.display = 'block'; // Show video container

            recordedChunks = [];
            recordingStartTime = Date.now();

            // Create media recorder
            mediaRecorder = new MediaRecorder(mediaStream, {
                mimeType: 'video/webm;codecs=vp9',
                videoBitsPerSecond: 2500000
            });

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
            };

            mediaRecorder.onstart = () => {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('recordingIndicator').style.display = 'flex';
                document.getElementById('audioVisualizerContainer').style.display = 'flex';
                setupAudioVisualizer();
                startTimer();
                showStatus('Recording in progress...', 'info');
            };

            mediaRecorder.onstop = () => {
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('recordingIndicator').style.display = 'none';
                document.getElementById('audioVisualizerContainer').style.display = 'none';
                stopAudioVisualizer();
                stopTimer();
                showStatus('Recording stopped. Review and submit or reset to try again.', 'success');
            };

            mediaRecorder.start();

            // Auto-stop after 1 minute
            setTimeout(() => {
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    stopRecording();
                    showStatus('Maximum recording time reached. Click "Submit" to submit your recording.', 'info');
                }
            }, maxRecordingTime);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
        }

        function resetRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
            }
            recordedChunks = [];
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('recordingIndicator').style.display = 'none';
            document.getElementById('audioVisualizerContainer').style.display = 'none';
            document.getElementById('timerDisplay').textContent = '00:00';
            document.getElementById('videoContainer').style.display = 'none'; // Hide video container
            stopTimer();
            stopAudioVisualizer();
            
            // Stop camera stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            showStatus('', '');
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - recordingStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                const displaySeconds = seconds % 60;
                document.getElementById('timerDisplay').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(displaySeconds).padStart(2, '0')}`;
            }, 100);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
            }
        }

        function submitRecording() {
            if (recordedChunks.length === 0) {
                showStatus('No recording found. Please record before submitting.', 'error');
                return;
            }

            const blob = new Blob(recordedChunks, { type: 'video/webm' });
            
            // Create FormData to send the recording
            const formData = new FormData();
            formData.append('recording', blob, 'recording.webm');
            formData.append('prompt', document.getElementById('promptText').textContent);

            // In production, send to server
            console.log('Submitting recording...');
            console.log('Recording size:', blob.size, 'bytes');
            
            // Stop camera stream
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }
            
            // Stop audio visualizer
            stopAudioVisualizer();
            
            // Hide recording interface
            document.getElementById('promptSection').style.display = 'none';
            document.getElementById('instructions').style.display = 'none';
            document.getElementById('videoContainer').style.display = 'none';
            document.getElementById('controlsSection').style.display = 'none';
            document.getElementById('statusMessage').style.display = 'none';
            
            // Show submitted screen
            document.getElementById('submittedScreen').style.display = 'block';
            
            document.getElementById('submitBtn').disabled = true;
        }

        function goToFeedback() {
            // In production: window.location.href = 'feedback.html';
            console.log('Redirecting to feedback.html');
            // For demo, just show that it's navigating
            document.getElementById('submittedScreen').innerHTML = '<p>Redirecting to feedback page...</p>';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.textContent = message;
            statusDiv.style.display = 'none';
            
            if (message) {
                statusDiv.style.display = 'block';
                
                if (type === 'success') {
                    statusDiv.style.backgroundColor = '#d4edda';
                    statusDiv.style.color = '#155724';
                    statusDiv.style.border = '1px solid #c3e6cb';
                } else if (type === 'error') {
                    statusDiv.style.backgroundColor = '#f8d7da';
                    statusDiv.style.color = '#721c24';
                    statusDiv.style.border = '1px solid #f5c6cb';
                } else if (type === 'info') {
                    statusDiv.style.backgroundColor = '#d1ecf1';
                    statusDiv.style.color = '#0c5460';
                    statusDiv.style.border = '1px solid #bee5eb';
                }
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>